# Release v0.2.1 - Environment Setup Bug Fixes

**Release Date:** 2025-11-25
**Version:** 0.2.1
**Type:** Bug Fix Release

---

## Overview

Version 0.2.1 is a bug fix release focused on the Environment Setup panel. This release addresses several UI/UX issues and fixes a critical bug where deleting an environment could inadvertently delete credentials shared with other environments.

**Key Fixes:**
- üîê Shared credentials are now preserved when deleting environments
- üîò Button states properly reset after cancel/completion
- üíæ New "Save" and "Save & Close" buttons for better workflow
- üé® Improved button alignment and modal dialogs
- üìú Persistence Inspector now scrolls properly

**User Impact:** Improved reliability when managing multiple environments with shared credentials.

---

## Bug Fixes

### Critical: Shared Credential Deletion

**Problem:** When two environments shared the same username/password (or clientId/clientSecret), deleting one environment would delete the shared credentials, breaking authentication for the remaining environment.

**Example scenario:**
1. Create "DEV Environment" with username `admin@contoso.com`
2. Create "TEST Environment" with same username `admin@contoso.com`
3. Delete "DEV Environment"
4. **Bug:** "TEST Environment" could no longer authenticate (password was deleted)

**Solution:** The repository now checks if any remaining environments use the same credentials before deleting. Only credentials that are not shared with other environments are removed.

**Files Changed:**
- `src/features/environmentSetup/infrastructure/repositories/EnvironmentRepository.ts`
- `src/features/environmentSetup/infrastructure/repositories/EnvironmentRepository.test.ts`

---

### Environment Setup: Button State Management

**Problem:** The "Discover ID" and "Test Connection" buttons would get stuck showing "Discovering..." or "Testing..." if the user cancelled the operation.

**Root Cause:** Race condition between the panel coordinator's button state management and the behavior's direct DOM manipulation. The coordinator was saving the "Discovering..." text as the "original" state and restoring it after the operation completed.

**Solution:** Disabled the coordinator's automatic button state management (`disableOnExecute: false`) for handlers where the behavior manages button state directly.

**Files Changed:**
- `src/features/environmentSetup/presentation/panels/EnvironmentSetupPanelComposed.ts`

---

### Environment Setup: Save Button Improvements

**Problem:** Users could only "Save & Close" - there was no way to save changes without closing the panel.

**Solution:** Added separate "Save" and "Save & Close" buttons:
- **Save:** Saves changes and shows "Saved!" feedback, panel stays open
- **Save & Close:** Saves changes and closes the panel

---

### Environment Setup: UI Polish

- **Button alignment:** Toolbar buttons now centered and right-aligned to match form content width
- **Modal dialogs:** Interactive auth warning now displays as a modal dialog instead of a corner notification (easier to notice and acknowledge)

---

### Persistence Inspector: Scroll Fix

**Problem:** The Persistence Inspector panel content would not scroll when there were many storage entries, making it impossible to view all data.

**Solution:** Added proper CSS flex layout to enable scrolling within the main content area.

**Files Changed:**
- `resources/webview/css/features/persistence-inspector.css`
- `src/features/persistenceInspector/presentation/sections/PersistenceInspectorSection.ts`

---

## Dependencies

- Upgraded TypeScript from 4.9.5 to 5.9.3
- Upgraded @azure/msal-node from 2.x to 3.8.3
- Upgraded madge from 7.0.0 to 8.0.0
- Upgraded @types/node from 16.x to 24.x
- Upgraded @typescript-eslint packages to 8.48.0
- Upgraded @vscode/vsce to 3.7.1
- Updated GitHub Actions (checkout v6, setup-node v6, codeql-action v4, github-script v8)

---

## Testing

All 845+ tests pass. New tests added for shared credential protection:
- `should NOT delete shared password when another environment uses the same username`
- `should NOT delete shared client secret when another environment uses the same clientId`
- `should delete unshared credentials when environment is deleted`

---

## Upgrade Notes

No breaking changes. Simply update to enjoy the bug fixes.
