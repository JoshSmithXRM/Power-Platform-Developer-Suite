{
  "metadata": {
    "environmentId": "env-1765563807619-5aegsdec0",
    "environmentName": "Demo - Dev",
    "environmentUrl": "https://orgcabef92d.crm.dynamics.com"
  },
  "cells": [
    {
      "kind": "markdown",
      "source": "# Virtual Field Edge Cases\n\nTesting how virtual fields (`*name`, `*yominame`) behave in different SQL clauses.\n\n## Decision\n- **Lookup fields** (`createdby`) → Return both GUID column + name column\n- **Optionset fields** (`statuscode`) → Return both value column + label column  \n- **Virtual fields in SELECT** (`createdbyname`) → TBD - error or map to parent?\n- **Virtual fields in WHERE** → Should work (filter by display name)\n- **Virtual fields in ORDER BY** → Should work (sort by display name)\n- **Yomi fields** → Dead, filter from IntelliSense\n\n---"
    },
    {
      "kind": "markdown",
      "source": "## Section 1: SELECT - Lookup Fields\n\nExpected: Selecting a lookup should return both the GUID and the display name"
    },
    {
      "kind": "sql",
      "source": "-- TEST 1.1: Single lookup field\n-- Expected: createdby (GUID) + createdbyname (display name)\nSELECT TOP 3\n    accountid,\n    name,\n    createdby\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 1.2: Multiple lookup fields\n-- Expected: Each lookup gets its own + name column\nSELECT TOP 3\n    accountid,\n    name,\n    createdby,\n    modifiedby,\n    ownerid\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 1.3: Explicit virtual field in SELECT\n-- Current: Returns empty column\n-- Question: Should this error? Map to parent? Or just work?\nSELECT TOP 3\n    accountid,\n    name,\n    createdbyname\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 1.4: Both parent and virtual explicitly selected\n-- Question: Duplicate columns? Or dedupe?\nSELECT TOP 3\n    accountid,\n    name,\n    createdby,\n    createdbyname\nFROM account"
    },
    {
      "kind": "markdown",
      "source": "## Section 2: SELECT - Optionset Fields\n\nExpected: Selecting an optionset should return both the value and the label"
    },
    {
      "kind": "sql",
      "source": "-- TEST 2.1: Single optionset field\n-- Expected: statuscode (int) + statuscodename (label)\nSELECT TOP 3\n    accountid,\n    name,\n    statuscode\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 2.2: Multiple optionset fields\n-- Expected: Each optionset gets value + name column\nSELECT TOP 3\n    accountid,\n    name,\n    statecode,\n    statuscode,\n    accountclassificationcode\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 2.3: Explicit optionset virtual field\n-- Current: Returns empty column\n-- Question: Should this error? Map to parent?\nSELECT TOP 3\n    accountid,\n    name,\n    statuscodename\nFROM account"
    },
    {
      "kind": "markdown",
      "source": "## Section 3: WHERE - Virtual Fields\n\nExpected: Virtual fields should work in WHERE clause (filter by display name/label)"
    },
    {
      "kind": "sql",
      "source": "-- TEST 3.1: WHERE with lookup virtual field (LIKE)\n-- Expected: Filter by display name\nSELECT TOP 10\n    accountid,\n    name,\n    createdby\nFROM account\nWHERE createdbyname LIKE '%System%'"
    },
    {
      "kind": "sql",
      "source": "-- TEST 3.2: WHERE with lookup virtual field (exact match)\n-- Expected: Filter by exact display name\nSELECT TOP 10\n    accountid,\n    name,\n    createdby\nFROM account\nWHERE createdbyname = 'SYSTEM'"
    },
    {
      "kind": "sql",
      "source": "-- TEST 3.3: WHERE with optionset virtual field (exact match)\n-- Expected: Filter by option label\nSELECT TOP 10\n    accountid,\n    name,\n    statuscode\nFROM account\nWHERE statuscodename = 'Active'"
    },
    {
      "kind": "sql",
      "source": "-- TEST 3.4: WHERE with optionset virtual field (LIKE)\n-- Expected: Filter by label pattern\nSELECT TOP 10\n    accountid,\n    name,\n    statuscode\nFROM account\nWHERE statuscodename LIKE '%Active%'"
    },
    {
      "kind": "sql",
      "source": "-- TEST 3.5: Complex WHERE - virtual + real fields\n-- Expected: Both conditions work\nSELECT TOP 10\n    accountid,\n    name,\n    createdby,\n    statuscode\nFROM account\nWHERE createdbyname LIKE '%System%'\n  AND statuscode = 1"
    },
    {
      "kind": "markdown",
      "source": "## Section 4: ORDER BY - Virtual Fields\n\nExpected: Virtual fields should work in ORDER BY (sort by display name/label)"
    },
    {
      "kind": "sql",
      "source": "-- TEST 4.1: ORDER BY lookup virtual field\n-- Expected: Sort by display name\nSELECT TOP 10\n    accountid,\n    name,\n    createdby\nFROM account\nORDER BY createdbyname ASC"
    },
    {
      "kind": "sql",
      "source": "-- TEST 4.2: ORDER BY optionset virtual field\n-- Expected: Sort by label\nSELECT TOP 10\n    accountid,\n    name,\n    statuscode\nFROM account\nORDER BY statuscodename DESC"
    },
    {
      "kind": "sql",
      "source": "-- TEST 4.3: ORDER BY virtual + real field\n-- Expected: Multi-column sort works\nSELECT TOP 10\n    accountid,\n    name,\n    statuscode,\n    createdby\nFROM account\nORDER BY statuscodename ASC, createdbyname DESC"
    },
    {
      "kind": "markdown",
      "source": "## Section 5: Yomi Fields (Dead - Should Not Work)\n\nExpected: Yomi fields should fail or return empty - they're not queryable"
    },
    {
      "kind": "sql",
      "source": "-- TEST 5.1: Yomi field in SELECT\n-- Expected: Empty column or error\nSELECT TOP 3\n    accountid,\n    name,\n    createdbyyominame\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 5.2: Yomi field in WHERE\n-- Expected: Error or no results\nSELECT TOP 3\n    accountid,\n    name,\n    createdby\nFROM account\nWHERE createdbyyominame IS NOT NULL"
    },
    {
      "kind": "sql",
      "source": "-- TEST 5.3: Yomi field in ORDER BY\n-- Expected: Error or ignored\nSELECT TOP 3\n    accountid,\n    name,\n    createdby\nFROM account\nORDER BY createdbyyominame ASC"
    },
    {
      "kind": "markdown",
      "source": "## Section 6: Aliases\n\nTesting how aliases interact with virtual field expansion"
    },
    {
      "kind": "sql",
      "source": "-- TEST 6.1: Alias on lookup field\n-- Expected: Both columns aliased? Or just the GUID?\nSELECT TOP 3\n  accountid,\n  name,\n  createdby AS creator\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 6.2: Alias on virtual field\n-- Expected: ??? (depends on how we handle virtual in SELECT)\nSELECT TOP 3\n    accountid,\n    name,\n    createdbyname AS creator_name\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 6.3: Alias on optionset\n-- Expected: Both columns aliased? Or just the value?\nSELECT TOP 3\n    accountid,\n    name,\n    statuscode AS status\nFROM account"
    },
    {
      "kind": "markdown",
      "source": "## Section 7: FetchXML Comparison\n\nDirect FetchXML to compare with SQL behavior"
    },
    {
      "kind": "fetchxml",
      "source": "<fetch top='3'>\n  <entity name='account'>\n    <attribute name='accountid' />\n    <attribute name='name' />\n    <attribute name='createdby' />\n  </entity>\n</fetch>"
    },
    {
      "kind": "fetchxml",
      "source": "<fetch top='3'>\n  <entity name='account'>\n    <attribute name='accountid' />\n    <attribute name='name' />\n    <attribute name='statuscode' />\n  </entity>\n</fetch>"
    },
    {
      "kind": "fetchxml",
      "source": "<fetch top='10'>\n  <entity name='account'>\n    <attribute name='accountid' />\n    <attribute name='name' />\n    <attribute name='createdby' />\n    <filter>\n      <condition attribute='createdbyname' operator='like' value='%System%' />\n    </filter>\n  </entity>\n</fetch>"
    },
    {
      "kind": "markdown",
      "source": "## Section 8: Edge Cases\n\nMiscellaneous edge cases"
    },
    {
      "kind": "sql",
      "source": "-- TEST 8.1: SELECT * (all attributes)\n-- Expected: All columns including virtual name columns?\nSELECT TOP 3 *\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 8.2: COUNT with virtual field in WHERE\n-- Expected: Count works with virtual field filter\nSELECT COUNT(accountid) as total\nFROM account\nWHERE createdbyname LIKE '%System%'"
    },
    {
      "kind": "sql",
      "source": "-- TEST 8.3: DISTINCT with lookup\n-- Expected: Distinct on GUID or on name?\nSELECT DISTINCT createdby\nFROM account"
    },
    {
      "kind": "sql",
      "source": "-- TEST 8.4: NULL check on virtual field\n-- Expected: Works or errors?\nSELECT TOP 5\n    accountid,\n    name,\n    createdby\nFROM account\nWHERE createdbyname IS NOT NULL"
    }
  ]
}