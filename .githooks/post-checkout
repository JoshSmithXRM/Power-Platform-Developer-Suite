#!/bin/bash
# Post-checkout hook: Auto-create symlinks for worktrees
# This runs after git checkout and git worktree add
#
# Symlinks worktree files to main repo (all gitignored):
# - .mcp.json (Dataverse MCP connection)
# - .claude/settings.local.json (Claude Code settings)
# - .env.e2e.local (E2E test credentials)
#
# Setup: git config core.hooksPath .githooks

# Helper function to create Windows symlink (silent on failure)
create_symlink() {
    local source="$1"
    local target="$2"

    local WIN_TARGET WIN_SOURCE
    WIN_TARGET=$(cygpath -w "$(pwd)/$target" 2>/dev/null) || return 0
    WIN_SOURCE=$(cygpath -w "$source" 2>/dev/null) || return 0

    cmd //c "mklink $WIN_TARGET $WIN_SOURCE" > /dev/null 2>&1
    [ $? -eq 0 ] && echo "âœ“ Linked: $target"
}

# Get main repo root (only works in worktrees)
GIT_COMMON_DIR=$(git rev-parse --git-common-dir 2>/dev/null)
[ -z "$GIT_COMMON_DIR" ] && exit 0

MAIN_REPO_ROOT=$(dirname "$GIT_COMMON_DIR")
CURRENT_DIR=$(pwd)

# Skip if we're in the main repo (not a worktree)
[ "$CURRENT_DIR" = "$MAIN_REPO_ROOT" ] && exit 0

# --- Symlink .mcp.json ---
MCP_SOURCE="$MAIN_REPO_ROOT/.mcp.json"
if [ -f "$MCP_SOURCE" ] && [ ! -e ".mcp.json" ]; then
    create_symlink "$MCP_SOURCE" ".mcp.json"
fi

# --- Symlink .claude/settings.local.json ---
CLAUDE_SOURCE="$MAIN_REPO_ROOT/.claude/settings.local.json"
if [ -f "$CLAUDE_SOURCE" ] && [ ! -e ".claude/settings.local.json" ]; then
    create_symlink "$CLAUDE_SOURCE" ".claude/settings.local.json"
fi

# --- Symlink .env.e2e.local ---
ENV_SOURCE="$MAIN_REPO_ROOT/.env.e2e.local"
if [ -f "$ENV_SOURCE" ] && [ ! -e ".env.e2e.local" ]; then
    create_symlink "$ENV_SOURCE" ".env.e2e.local"
fi

exit 0
