#!/bin/bash
# Post-checkout hook: Auto-create symlinks for worktrees
# This runs after git checkout and git worktree add
#
# Symlinks worktree files to main repo (all gitignored):
# - .mcp.json (Dataverse MCP connection)
# - .claude/settings.local.json (Claude Code settings)
# - .env.e2e.local (E2E test credentials)
#
# Setup: git config core.hooksPath .githooks

# Cross-platform symlink creation
create_symlink() {
    local source="$1"
    local target="$2"

    # Ensure parent directory exists
    if [[ "$target" == */* ]]; then
        mkdir -p "$(dirname "$target")"
    fi

    if command -v cygpath >/dev/null 2>&1; then
        # Windows (Git Bash/Cygwin)
        local WIN_TARGET WIN_SOURCE
        WIN_TARGET=$(cygpath -w "$(pwd)/$target" 2>/dev/null) || return 0
        WIN_SOURCE=$(cygpath -w "$source" 2>/dev/null) || return 0
        cmd //c "mklink \"$WIN_TARGET\" \"$WIN_SOURCE\"" > /dev/null 2>&1
    else
        # Unix (macOS/Linux)
        ln -s "$source" "$target" 2>/dev/null
    fi

    [ $? -eq 0 ] && echo "âœ“ Linked: $target"
}

# Get main repo root (only works in worktrees)
GIT_COMMON_DIR=$(git rev-parse --git-common-dir 2>/dev/null)
[ -z "$GIT_COMMON_DIR" ] && exit 0

MAIN_REPO_ROOT=$(dirname "$GIT_COMMON_DIR")
CURRENT_DIR=$(pwd)

# Skip if we're in the main repo (not a worktree)
[ "$CURRENT_DIR" = "$MAIN_REPO_ROOT" ] && exit 0

# Files to symlink from main repo
FILES_TO_LINK=(
    ".mcp.json"
    ".claude/settings.local.json"
    ".env.e2e.local"
)

for target in "${FILES_TO_LINK[@]}"; do
    source="$MAIN_REPO_ROOT/$target"
    if [ -f "$source" ] && [ ! -e "$target" ]; then
        create_symlink "$source" "$target"
    fi
done

exit 0
